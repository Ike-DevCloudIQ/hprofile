name: Hprofile Actions
on: workflow_dispatch
jobs:
  Testing:
    runs-on: ubuntu-latest
    steps:
      - name: Code checkout
        uses: actions/checkout@v4

      # Setup Java 17 (recommended for SonarCloud and modern projects)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
         distribution: 'temurin'
         java-version: '17'
         cache: 'maven'

      # Verify Java and Maven versions for SonarCloud compatibility
      - name: Verify Java and Maven versions
        run: |
          echo "=== Version Compatibility Check ==="
          echo "Java version (should be 11+ for SonarCloud):"
          java -version
          echo ""
          echo "Maven version (should be 3.6+ for SonarCloud):"
          mvn -version
          echo ""
          echo "=== Checking SonarCloud Requirements ==="
          echo "✓ Java 17 - Fully supported by SonarCloud"
          echo "✓ Maven 3.6+ - Default in GitHub Actions"

      # Clean Maven plugin cache to avoid classloading issues
      - name: Clean Maven plugin cache
        run: |
          mvn dependency:purge-local-repository
          mvn clean

      # Run Maven verify (includes compile, test, package)
      - name: Maven verify
        run: mvn verify

      # Run Checkstyle analysis
      - name: Checkstyle
        run: mvn checkstyle:checkstyle

      # Generate JaCoCo coverage report
      - name: Generate JaCoCo report
        run: mvn jacoco:report

      # Cache SonarCloud packages
      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      # Run SonarCloud analysis using pinned version for stability
      - name: Analyze with SonarCloud
        uses: SonarSource/sonarcloud-github-action@v2.3.0
        with:
          args: >
            -Dsonar.projectKey=hprofile2026_hprofile2026
            -Dsonar.organization=hprofile2026
            -Dsonar.sources=src/main/java
            -Dsonar.tests=src/test/java
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
            -Dsonar.junit.reportPaths=target/surefire-reports
            -Dsonar.java.checkstyle.reportPaths=target/checkstyle-result.xml
            -Dsonar.java.binaries=target/classes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      # Check the Quality Gate status.
      - name: SonarQube Quality Gate check
        id: sonarqube-quality-gate-check
        uses: sonarsource/sonarqube-quality-gate-action@master
        # Force to fail step after specific time.
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_URL }} #OPTIONAL   
